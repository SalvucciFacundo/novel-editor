<aside class="ai-chat">

    <!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <header class="ai-chat__header">
        <span class="ai-chat__title">âœ¦ IA</span>

        <!-- Mode selector -->
        <div class="mode-toggle">
            <button [class.active]="mode() === 'query'" (click)="setMode('query')">Consulta</button>
            <button [class.active]="mode() === 'agent'" (click)="setMode('agent')">Agente</button>
        </div>

        <button class="icon-btn-sm" (click)="showConfig.set(!showConfig())" title="Configurar IA">âš™</button>
        <button class="ai-chat__close-btn" (click)="close.emit()" title="Cerrar chat"
            aria-label="Cerrar chat">âœ•</button>
    </header>

    <!-- â”€â”€ CONFIG PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    @if (showConfig()) {
    <div class="ai-chat__config">
        <label class="config-label">Proveedor</label>
        <select class="config-select" (change)="selectProvider($any($event.target).value)">
            @for (p of providers; track p.id) {
            <option [value]="p.id">{{ p.label }}</option>
            }
        </select>

        <!-- URL personalizada (Colab / cualquier endpoint) -->
        @if (selectedProvider().customUrl) {
        <label class="config-label">URL del endpoint <span class="config-hint-inline">(OpenAI-compatible)</span></label>
        <input class="config-input" type="text" [(ngModel)]="customUrl"
            placeholder="https://xxxx-xx-xx.ngrok-free.app/v1/chat/completions" />
        <label class="config-label">Nombre del modelo</label>
        <input class="config-input" type="text" [(ngModel)]="customModel"
            placeholder="ej: local-model, mistral, llama3" />
        <p class="config-hint">Servidor levantado en Colab con API compatible con OpenAI (vLLM, llama.cpp, etc.)</p>
        } @else {
        <label class="config-label">Modelo</label>
        <select class="config-select" [ngModel]="selectedModel()" (ngModelChange)="selectedModel.set($event)">
            @for (m of selectedProvider().models; track m) {
            <option [value]="m">{{ m }}</option>
            }
        </select>
        }

        @if (selectedProvider().id !== 'ollama' && !selectedProvider().customUrl) {
        <label class="config-label">API Key</label>
        <input class="config-input" type="password" [(ngModel)]="apiKey" placeholder="sk-..." autocomplete="off" />
        } @else if (selectedProvider().id === 'ollama') {
        <p class="config-hint">Ollama debe estar corriendo en localhost:11434</p>
        }

        <div class="config-divider" aria-hidden="true"></div>

        <!-- Preset de system prompt -->
        <label class="config-label">Perfil de escritura</label>
        <div class="config-preset-row">
            @for (key of promptPresetsKeys; track key) {
            <button class="config-preset-btn" [class.active]="promptPreset() === key"
                (click)="promptPreset.set(key)" type="button">
                {{ promptPresetLabels[key] }}
            </button>
            }
        </div>

        @if (promptPreset() === 'personalizado') {
        <label class="config-label">System prompt personalizado</label>
        <textarea class="config-textarea" [(ngModel)]="customSystemPrompt" rows="6"
            placeholder="DefinÃ­ el rol, estilo y comportamiento del modelo..."></textarea>
        }
    </div>
    }

    <!-- â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ai-chat__messages" #messagesEl>
        @if (messages().length === 0) {
        <div class="ai-chat__empty">
            <p>{{ mode() === 'agent' ? 'ðŸ¤– Modo agente activado. Puedo modificar tu texto.' : 'ðŸ’¬ HacÃ© una consulta
                sobre tu historia.' }}</p>
        </div>
        }

        @for (msg of messages(); track $index) {
        <div class="message" [class.message--user]="msg.role === 'user'"
            [class.message--assistant]="msg.role === 'assistant'">
            @if (msg.imageBase64) {
            <img class="message__image" [src]="msg.imageBase64" alt="Imagen adjunta" />
            }
            <p class="message__content">{{ msg.content }}</p>

            @if (msg.role === 'assistant' && mode() === 'agent') {
            <button class="message__apply-btn" (click)="applyToEditor(msg.content)" title="Insertar en el editor">
                â†“ Insertar en editor
            </button>
            }
        </div>
        }

        @if (loading()) {
        <div class="message message--assistant">
            <div class="message__typing">
                <span></span><span></span><span></span>
            </div>
        </div>
        }
    </div>

    <!-- â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="ai-chat__input-area">
        <!-- Preview de imagen -->
        @if (imagePreview()) {
        <div class="image-preview">
            <img [src]="imagePreview()" alt="Imagen seleccionada" />
            <button class="image-preview__remove" (click)="removeImage()">âœ•</button>
        </div>
        }

        <div class="ai-chat__input-row">
            <!-- Upload imagen -->
            <label class="btn-attach" title="Adjuntar imagen" aria-label="Adjuntar imagen">
                ðŸ“Ž
                <input #fileInput type="file" accept="image/*" class="sr-only" (change)="onFileSelected($event)" />
            </label>

            <textarea class="ai-chat__textarea" [(ngModel)]="userInput" placeholder="EscribÃ­ tu consulta..." rows="4"
                (keydown.enter)="onEnterKey($event)">
      </textarea>

            <button class="btn-send" (click)="sendMessage()"
                [disabled]="loading() || (!userInput.trim() && !imagePreview())" aria-label="Enviar">
                âž¤
            </button>
        </div>

        <div class="ai-chat__footer-actions">
            <button class="link-btn" (click)="clearChat()">Limpiar chat</button>
        </div>
    </div>

</aside>